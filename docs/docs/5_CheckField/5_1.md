# 5.1 治療装置名のチェック

## 目的

統一された治療装置が選択されているかチェックします。

## 必要な情報

プランで使用されている治療装置名

## 与えられている引数

`PlanSetup`クラスのインスタンス`plan`

## 必要な情報へのアクセス方法

現在開いているプランの`最初の照射野`で設定されている治療装置IDへアクセスするには、以下のようにします。

照射野情報はシーケンスに格納されており、指定されたインデックスの要素を取得するために ElementAt() を使用します。
ElementAt(0)を指定することで最初の照射野情報を取得できます。

治療装置IDは TreatmentUnit.Id に格納されています。

```csharp
string machine = plan.Beams.ElementAt(0).TreatmentUnit.Id;
```

## 実装

本演習ではプランの治療装置が統一されているかチェックする仕組みを作ります。

上記の方法で最初の照射野情報から治療装置IDを取得し、
foreach構文ですべての照射野情報にアクセスしてこの装置名と一致しているかを確認します。
異なる装置が設定されている場合にメッセージを出力するようにします。

セットアップフィールドは IsSetupField で判定することができます。

```csharp
////////////////////////////////////////////////////////////////////////////////
// Check Treatment Machine
//
checkName = "Check treatment machine";

　～～以下にコードを記述～～
```

###  実装例

装置が統一されていたかを判定するためのbool型変数を定義する。
最初の照射野情報に設定された装置と比較して異なる場合には照射野IDと装置IDを出力する。
一致していたときには何も出力されない。

```csharp
// 装置が統一されていたかを判定するためのbool型変数を定義してtrueで初期化。
bool machineChkFlag = true;

// 最初の照射野情報に設定された装置の取得
string machine = plan.Beams.ElementAt(0).TreatmentUnit.Id;

// foreach構文でループしてすべての照射野について確認する
foreach (var beam in plan.Beams)
{
    // セットアップフィールドの判定 -> セットアップフィールドではないときに次の判定にすすむ。
    if (!beam.IsSetupField)
    {
        // 最初の照射野情報に設定された装置と異なる場合
        if (machine != beam.TreatmentUnit.Id)
        {
            //machineChkFlagをfalseに変更
            machineChkFlag = false;
            //設定が間違っている照射野IDと装置IDを出力する
            oText += MakeFormatText(false, checkName, beam.Id + ": " + beam.TreatmentUnit.Id + " -> " + machine);
        }                 
    }
}

// すべての照射野の装置が統一して設定されていた場合（machineChkFlagがtrueの場合）
if (machineChkFlag == true)
{    
    //何も出力しない
    oText += MakeFormatText(true, checkName, "");
}
```
